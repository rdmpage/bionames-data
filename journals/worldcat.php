<?php

/*

Given a list if ISSNs fetch data from WorldCat. Add any preceding or succeeding ISSN to a queue and
add them.
 
*/

require_once (dirname(dirname(__FILE__)) . '/adodb5/adodb.inc.php');
require_once (dirname(dirname(__FILE__)). '/couchsimple.php');
require_once (dirname(dirname(__FILE__)) . '/lib.php');

//--------------------------------------------------------------------------------------------------
$db = NewADOConnection('mysqli');
$db->Connect("localhost", 
	'root' , '' , 'ion');

// Ensure fields are (only) indexed by column name
$ADODB_FETCH_MODE = ADODB_FETCH_ASSOC;



//--------------------------------------------------------------------------------------------------
// Journal thumbnail
function get_issn_thumbnail(&$journal)
{
	global $db;

	$issn = $journal->_id;
	$issn = str_replace('issn/', '', $issn);	
	
	$thumbnail = '';

	$sql = "SELECT * FROM new_issn_thumbnails WHERE issn = " . $db->qstr($issn) . " LIMIT 1;";
	
	$result = $db->Execute($sql);
	if ($result == false) die("failed [" . __FILE__ . ":" . __LINE__ . "]: " . $sql);
	
	if ($result->NumRows() == 1)
	{
		$thumbnail = $result->fields['path'];
		
		$filename = '/Users/rpage/Sites/itaxon/thumbnails/' . $thumbnail;
		
		$image_type = exif_imagetype($filename);
		switch ($image_type)
		{
			case IMAGETYPE_GIF:
				$mime_type = 'image/gif';
				break;
			case IMAGETYPE_JPEG:
				$mime_type = 'image/jpg';
				break;
			case IMAGETYPE_PNG:
				$mime_type = 'image/png';
				break;
			case IMAGETYPE_TIFF_II:
			case IMAGETYPE_TIFF_MM:
				$mime_type = 'image/tif';
				break;
			default:
				$mime_type = 'image/gif';
				break;
		}
		
		$image = file_get_contents($filename);
		$base64 = chunk_split(base64_encode($image));
		$journal->thumbnail = 'data:' . $mime_type . ';base64,' . $base64;				
	}
}

/*

//--------------------------------------------------------------------------------------------------
// Journal thumbnail
function get_issn_thumbnail(&$journal)
{
	$issn = $journal->_id;
	$issn = str_replace('issn/', '', $issn);
	
	$url = 'http://bioguid.info/issn/image.php?issn=' . $issn;
	$image = get($url);
	
	if ($image != '')
	{				
		$filename = 'images/' . str_replace('-', '', $issn);
		
		file_put_contents($filename, $image);
		
		$image_type = exif_imagetype($filename);
		switch ($image_type)
		{
			case IMAGETYPE_GIF:
				$mime_type = 'image/gif';
				break;
			case IMAGETYPE_JPEG:
				$mime_type = 'image/jpg';
				break;
			case IMAGETYPE_PNG:
				$mime_type = 'image/png';
				break;
			case IMAGETYPE_TIFF_II:
			case IMAGETYPE_TIFF_MM:
				$mime_type = 'image/tif';
				break;
			default:
				$mime_type = 'image/gif';
				break;
		}
		
		// make file "visible" by adding extension
		$fname = $filename . str_replace('image/', '.', $mime_type);
		rename($filename, $fname);
		
		
		$base64 = chunk_split(base64_encode($image));
		$journal->thumbnail = 'data:' . $mime_type . ';base64,' . $base64;				
	}		
}

*/

$issns = array('0022-2933', '0374-5481');

//$issns = array('0068-547X');

//$issns = array('0006-324X');

$issns = array('0374-5481');

$issns = array('0077-7749');
$issns = array('0031-0220');
$issns = array('0079-8835');
$issns = array('0025-1461');


$issns = array('0007-1498'); // breaks code epically :(

$issns=array('0022-2372');
$issns=array('0027-4100');
$issns=array('0149-175X');
$issns=array('0374-5481');
$issns=array('0003-0082');
$issns=array('0370-2774');
$issns=array('0006-7172');
$issns=array('1616-5047');
$issns=array('1508-1109');
$issns=array('0008-4301');
$issns=array('0082-5107');
$issns=array('0016-6995');
$issns=array('0077-2070');
$issns=array('0067-1975');
$issns=array('1217-8837');
$issns=array('0384-8159'); // another example
$issns=array('0067-4745');
$issns=array('0923-9308');
$issns=array('0376-0375');
$issns=array('0008-6452');
$issns=array('0028-0119');
$issns=array('0012-723X');
$issns=array('0310-0049');
$issns=array('0580-3896');
$issns=array('0067-2238');
$issns=array('0508-4865');
$issns=array('0096-2961');
$issns=array('0370-047X');
$issns=array('0015-0754');
$issns=array('1280-9551');
$issns=array('0041-1752');
$issns=array('1935-3952');
$issns=array('0037-2102');
$issns=array('0035-418X');
$issns=array('0546-0670');
$issns=array('0006-324X');
$issns=array('0272-4634');
$issns=array('0003-0090');
$issns=array('0312-3162');

$issns=array('0006-6982');
$issns=array('0084-5620');
$issns=array('0028-1042');
$issns=array('0289-0003');
$issns=array('0096-3801');
$issns=array('0065-1710');
$issns=array('0024-0672');

$issns=array('0366-3515');
$issns=array('0038-4909');
$issns=array('0370-3908');

$issns=array('1175-5326');

$issns=array('0749-8934');
$issns=array('1000-0739');

$issns=array('1070-9428');
$issns=array('0373-3491');
$issns=array('1026-051X');
$issns=array('0003-0023');

$issns=array('0037-5942');

$issns=array('1280-9659');

$issns=array('0033-2615','0085-5626');

//$issns=array('0025-3154');

//$issns=array('0384-8159');

$issns = array('0007-1498');

$issns=array(
/*'0001-3765',
'0001-4036',
'0001-4087',
'0001-5202',
'0001-5326',
'0001-6152',
'0001-6616',
'0001-7280',
'0001-7302',
'0002-1911',
'0002-7014',
'0002-8320',
'0002-8487',
'0002-9122',
'0002-9483',
'0002-9599',
'0002-9637',
'0003-0023',
'0003-0031',
'0003-0082',
'0003-0090',
'0003-0147',
'0003-049X',
'0003-3162',
'0003-4088',
'0003-4150',
'0003-4339',
'0003-4541',
'0003-455X',
'0003-4746',
'0003-4983',
'0003-5092',
'0003-6862',
'0003-9136',
'0003-9365',
'0003-9667',
'0003-9705',
'0004-2110',
'0004-8038',
'0004-959X',
'0005-2086',
'0005-6219',
'0005-7959',
'0005-8130',
'0005-9439',
'0006-3088',
'0006-3118',
'0006-3185',
'0006-324X',
'0006-3304',
'0006-3568',
'0006-3606',
'0006-6982',
'0006-7172',
'0006-8055',
'0006-9698',
'0007-1471',
'0007-1498',
'0007-1595',
'0007-4187',
'0007-4853',
'0007-4977',
'0007-5167',
'0007-9723',
'0008-347X',
'0008-3550',
'0008-4026',
'0008-4077',
'0008-4301',
'0008-6452',
'0009-3262',
'0009-5915',
'0010-065X',
'0010-406X',
'0010-5422',
'0011-216X',
'0011-3891',
'0011-7471',
'0012-0065',
'0012-723X',
'0012-8317',
'0012-9402',
'0012-9658',
'0013-6220',
'0013-8703',
'0013-8711',
'0013-872X',
'0013-8738',
'0013-8746',
'0013-8762',
'0013-8770',
'0013-8789',
'0013-8797',
'0013-8819',
'0013-8827',
'0013-8835',
'0013-8843',
'0013-8851',
'0013-886X',
'0013-8878',
'0013-8894',
'0013-8908',
'0013-8916',
'0013-8940',
'0013-8959',
'0013-9440',
'0014-3820',
'0014-4754',
'0014-4827',
'0014-4894',
'0015-0754',
'0015-296X',
'0015-3850',
'0015-4040',
'0015-5683',
'0015-5713',
'0015-9301',
'0016-531X',
'0016-6707',
'0016-6995',
'0016-7568',
'0016-7622',
'0016-7630',
'0016-7746',
'0016-7835',
'0016-7878',
'0016-8238',
'0017-3614',
'0017-7424',
'0017-9957',
'0018-0130',
'0018-067X',
'0018-0831',
'0018-084X',
'0018-344X',
'0018-3466',
'0018-8158',
'0018-9634',
'0019-1019',
'0019-2252',
'0019-5227',
'0020-1804',
'0020-1812',
'0020-2495',
'0020-7519',
'0020-9309',
'0021-2164',
'0021-2210',
'0021-4280',
'0021-4914',
'0021-5090',
'0021-5104',
'0021-5171',
'0021-7719',
'0021-8375',
'0021-8782',
'0021-9533',
'0022-0019',
'0022-0493',
'0022-0981',
'0022-1007',
'0022-1112',
'0022-149X',
'0022-1511',
'0022-1899',
'0022-1910',
'0022-2011',
'0022-2372',
'0022-2402',
'0022-2585',
'0022-2844',
'0022-2933',
'0022-300X',
'0022-3360',
'0022-3395',
'0022-3646',
'0022-3921',
'0022-409X',
'0022-474X',
'0022-5320',
'0022-8443',
'0022-8567',
'0022-8850',
'0023-0081',
'0023-1339',
'0023-3366',
'0023-3374',
'0023-4001',
'0023-5377',
'0023-6152',
'0024-0672',
'0024-0966',
'0024-0974',
'0024-1164',
'0024-1652',
'0024-4066',
'0024-4074',
'0024-4082',
'0024-5461',
'0024-7774',
'0025-1194',
'0025-1291',
'0025-1461',
'0025-3146',
'0025-3154',
'0025-3162',
'0026-279X',
'0026-2803',
'0026-9786',
'0027-4070',
'0027-4100',
'0027-5514',
'0027-7452',
'0027-8424',
'0028-0119',
'0028-0798',
'0028-0836',
'0028-1042',
'0028-1344',
'0028-2596',
'0028-2944',
'0028-2960',
'0028-7199',
'0028-8306',
'0028-8330',
'0029-344X',
'0029-4594',
'0029-4608',
'0029-5035',
'0029-6864',
'0029-7224',
'0029-7240',
'0029-814X',
'0029-8519',
'0030-0950',
'0030-2465',
'0030-4158',
'0030-5316',
'0030-6525',
'0030-8714',
'0030-8870',
'0030-9923',
'0031-0182',
'0031-0204',
'0031-0220',
'0031-0239',
'0031-0247',
'0031-0301',
'0031-031X',
'0031-0603',
'0031-1049',
'0031-1820',
'0031-1847',
'0031-4056',
'0031-7683',
'0031-8884',
'0032-3780',
'0032-6275',
'0032-8332',
'0033-2615',
'0033-5037',
'0034-6667',
'0034-7108',
'0034-740X',
'0034-7736',
'0034-7744',
'0034-8910',
'0034-9623',
'0035-1598',
'0035-1814',
'0035-1822',
'0035-418X',
'0035-6387',
'0035-6883',
'0035-8894',
'0035-9181',
'0035-919X',
'0035-9203',
'0035-9211',
'0035-922X',
'0036-3375',
'0036-4827',
'0036-5343',
'0036-7575',
'0036-8075',
'0036-9276',
'0037-2102',
'0037-2110',
'0037-2870',
'0037-3680',
'0037-5942',
'0037-8437',
'0037-850X',
'0037-8518',
'0037-8747',
'0037-8844',
'0037-9026',
'0037-9255',
'0037-9271',
'0037-928X',
'0037-9409',
'0037-9603',
'0037-962X',
'0038-0717',
'0038-2353',
'0038-3872',
'0038-4909',
'0039-7989',
'0040-313X',
'0040-7496',
'0041-1752',
'0041-3259',
'0041-3860',
'0041-4018',
'0041-994X',
'0042-3211',
'0042-3580',
'0042-5184',
'0042-9686',
'0043-0439',
'0043-0927',
'0043-5163',
'0044-0604',
'0044-2291',
'0044-3255',
'0044-3468',
'0044-3778',
'0044-3808',
'0044-5088',
'0044-5096',
'0044-5118',
'0044-5134',
'0044-5150',
'0044-5177',
'0044-5193',
'0044-5231',
'0044-586X',
'0044-5967',
'0044-8486',
'0045-8511',
'0046-5070',
'0047-2417',
'0047-2484',
'0049-1128',
'0049-1136',
'0065-1028',
'0065-1478',
'0065-1583',
'0065-1710',
'0065-1729',
'0065-1737',
'0065-535X',
'0065-5503',
'0065-6755',
'0065-8162',
'0065-8170',
'0065-9452',
'0065-9746',
'0066-4634',
'0066-7781',
'0066-7870',
'0067-1967',
'0067-1975',
'0067-2238',
'0067-4745',
'0067-6160',
'0067-8546',
'0067-8716',
'0068-1024',
'0068-5143',
'0068-5461',
'0068-547X',
'0068-6417',
'0068-6506',
'0068-7650',
'0068-7995',
'0069-2379',
'0069-570X',
'0069-8970',
'0069-8989',
'0070-6698',
'0070-7260',
'0070-7279',
'0071-0792',
'0071-0806',
'0071-1268',
'0072-1050',
'0072-9027',
'0072-9612',
'0073-134X',
'0073-4721',
'0073-4748',
'0073-4918',
'0073-6600',
'0073-9901',
'0074-0276',
'0075-5028',
'0075-5036',
'0075-6458',
'0075-6547',
'0076-0935',
'0076-2997',
'0076-3721',
'0076-8405',
'0076-8413',
'0077-2070',
'0077-2135',
'0077-2232',
'0077-2356',
'0077-6122',
'0077-7579',
'0077-7749',
'0077-8923',
'0077-961X',
'0077-9962',
'0078-0421',
'0078-1304',
'0078-2564',
'0078-5326',
'0078-7515',
'0078-8562',
'0078-8597',
'0078-9747',
'0079-032X',
'0079-4295',
'0079-6611',
'0079-8045',
'0079-8835',
'0080-2247',
'0080-2425',
'0080-312X',
'0080-4568',
'0080-469X',
'0080-4703',
'0080-5920',
'0080-5947',
'0080-8318',
'0080-889X',
'0080-9462',
'0081-0266',
'0081-0282',
'0081-3745',
'0081-3753',
'0081-8720',
'0082-3074',
'0082-4755',
'0082-5107',
'0082-6340',
'0082-9811',
'0083-5986',
'0083-6060',
'0083-6133',
'0083-7903',
'0084-0505',
'0084-5604',
'0084-5620',
'0084-5647',
'0085-0683',
'0085-2988',
'0085-5278',
'0085-5626',
'0090-0656',
'0090-9246',
'0091-3669',
'0091-7958',
'0093-4666',
'0093-6812',
'0094-6214',
'0094-8373',
'0095-1137',
'0095-8530',
'0095-9758',
'0096-1191',
'0096-2651',
'0096-2961',
'0096-3801',
'0096-4069',
'0096-5294',
'0096-7750',
'0096-8749',
'0097-0298',
'0097-3157',
'0097-3904',
'0097-4374',
'0097-4463',
'0099-4936',
'0101-8175',
'0102-0935',
'0103-6076',
'0103-9121',
'0104-6497',
'0104-6950',
'0105-3574',
'0106-2808',
'0107-055X',
'0107-5896',
'0110-618X',
'0110-943X',
'0111-5383',
'0113-7492',
'0120-0488',
'0121-733X',
'0122-9761',
'0123-3068',
'0132-8069',
'0132-8077',
'0136-0027',
'0136-006X',
'0137-1592',
'0138-0338',
'0138-6476',
'0139-7893',
'0140-7775',
'0142-7873',
'0145-9058',
'0147-1724',
'0147-9369',
'0149-175X',
'0150-9330',
'0152-674X',
'0158-0760',
'0158-4197',
'0160-239X',
'0161-8202',
'0163-5395',
'0164-0291',
'0164-7954',
'0165-0424',
'0165-0521',
'0165-1609',
'0165-5752',
'0165-9464',
'0167-6563',
'0168-8162',
'0169-0237',
'0172-7761',
'0172-9179',
'0173-1076',
'0173-5373',
'0173-9565',
'0176-5027',
'0177-0950',
'0177-5103',
'0177-7424',
'0177-9214',
'0178-2762',
'0181-0626',
'0181-0642',
'0181-0863',
'0183-9187',
'0184-0266',
'0185-3880',
'0191-6122',
'0195-6671',
'0196-0768',
'0196-5581',
'0203-4646',
'0205-3640',
'0206-0477',
'0210-5004',
'0210-5985',
'0210-8984',
'0212-3010',
'0213-6686',
'0214-8358',
'0217-2445',
'0232-5535',
'0237-5419',
'0238-1249',
'0239-751X',
'0240-8783',
'0250-4413',
'0251-074X',
'0252-192X',
'0252-1962',
'0253-116X',
'0253-2484',
'0253-3340',
'0253-505X',
'0253-5890',
'0254-1858',
'0254-4059',
'0254-5578',
'0254-5853',
'0255-0091',
'0255-0105',
'0255-7576',
'0255-9587',
'0256-971X',
'0258-2619',
'0258-462X',
'0260-1230',
'0262-821X',
'0263-5933',
'0268-0130',
'0269-283X',
'0270-2444',
'0270-2452',
'0272-463',
'0272-4634',
'0275-2565',
'0277-3791',
'0278-0372',
'0278-3355',
'0284-7280',
'0285-3191',
'0286-9810',
'0287-0223',
'0287-3478',
'0289-0003',
'0300-3256',
'0300-5267',
'0300-9386',
'0301-2123',
'0301-4223',
'0301-8059',
'0301-9268',
'0302-7562',
'0303-2515',
'0303-6758',
'0303-688X',
'0303-6960',
'0303-7762',
'0303-9846',
'0304-0798',
'0304-2146',
'0304-3711',
'0304-4017',
'0305-0270',
'0305-1838',
'0305-1978',
'0305-8719',
'0307-6970',
'0310-0049',
'0310-9089',
'0311-1881',
'0311-5518',
'0311-9548',
'0312-3162',
'0313-122X',
'0318-1278',
'0320-9180',
'0323-5408',
'0323-6145',
'0323-7087',
'0325-2264',
'0326-1778',
'0326-4017',
'0326-551X',
'0326-9310',
'0327-9383',
'0332-575X',
'0332-6683',
'0334-2123',
'0340-4781',
'0340-4943',
'0340-6725',
'0341-0145',
'0341-0153',
'0341-4116',
'0341-8391',
'0342-7536',
'0343-3528',
'0352-5740',
'0354-4664',
'0361-6525',
'0362-2525',
'0362-9236',
'0363-1095',
'0365-0898',
'0365-4389',
'0365-4508',
'0365-6136',
'0365-6527',
'0365-6934',
'0365-7000',
'0365-9402',
'0366-1326',
'0366-2357',
'0366-3272',
'0366-3450',
'0366-3469',
'0366-3515',
'0366-5232',
'0366-5348',
'0366-6611',
'0367-1445',
'0367-4673',
'0367-5041',
'0367-8288',
'0368-0177',
'0368-1254',
'0368-2188',
'0368-2889',
'0368-2935',
'0368-3915',
'0368-3974',
'0368-4113',
'0368-4717',
'0368-8720',
'0369-6111',
'0369-8084',
'0369-8467',
'0369-9846',
'0370-0097',
'0370-0461',
'0370-047X',
'0370-1263',
'0370-1662',
'0370-2588',
'0370-2774',
'0370-2952',
'0370-3878',
'0370-3908',
'0370-4327',
'0370-4556',
'0371-6023',
'0371-9952',
'0372-0888',
'0372-1426',
'0372-9389',
'0373-0972',
'0373-3491',
'0373-3874',
'0373-4129',
'0373-4137',
'0373-465X',
'0373-5680',
'0373-6709',
'0373-7586',
'0373-8493',
'0373-8981',
'0373-9465',
'0373-9627',
'0374-1036',
'0374-5481',
'0374-6038',
'0374-6429',
'0374-8995',
'0374-9142',
'0374-9797',
'0375-0183',
'0375-0205',
'0375-0299',
'0375-0434',
'0375-0442',
'0375-0825',
'0375-099X',
'0375-2909',
'0375-5223',
'0375-7587',
'0376-0375',
'0376-1819',
'0376-2750',
'0377-8142',
'0377-8398',
'0378-1909',
'0378-2697',
'0378-6870',
'0379-0703',
'0379-1785',
'0379-6051',
'0380-9633',
'0384-8159',
'0385-0900',
'0385-2423',
'0385-244X',
'0385-5643',
'0386-0744',
'0386-233X',
'0386-5541',
'0387-5733',
'0387-9089',
'0387-964X',
'0388-2357',
'0388-6182',
'0388-788X',
'0389-1445',
'0389-6609',
'0391-7746',
'0391-9749',
'0392-0062',
'0392-6672',
'0392-7296',
'0392-758X',
'0393-4683',
'0394-6975',
'0398-4346',
'0399-0974',
'0399-1075',
'0418-1867',
'0424-7086',
'0428-0709',
'0429-288X',
'0430-3776',
'0433-8731',
'0437-2514',
'0438-0479',
'0440-2510',
'0440-6605',
'0440-8756',
'0452-9987',
'0453-0853',
'0454-6296',
'0454-7810',
'0459-8113',
'0473-9868',
'0474-0394',
'0493-3168',
'0505-205X',
'0506-8916',
'0508-4865',
'0511-7542',
'0520-1969',
'0521-4726',
'0524-4994',
'0524-6431',
'0529-6579',
'0539-2438',
'0546-0670',
'0548-1686',
'0555-7631',
'0556-655X',
'0557-417X',
'0559-9822',
'0562-4452',
'0567-655X',
'0567-7920',
'0568-658X',
'0569-4450',
'0570-1880',
'0571-5628',
'0577-3180',
'0578-1604',
'0580-3896',
'0580-5791',
'0583-7731',
'0583-8401',
'0590-6342',
'0706-652X',
'0716-0178',
'0716-078X',
'0716-2545',
'0717-652X',
'0718-8730',
'0722-4028',
'0722-4060',
'0728-4683',
'0730-8000',
'0732-4952',
'0733-1347',
'0733-2076',
'0734-9874',
'0735-6250',
'0736-0460',
'0737-4038',
'0740-2783',
'0740-8196',
'0743-9547',
'0747-8194',
'0748-3007',
'0749-6737',
'0749-8004',
'0749-8934',
'0750-7321',
'0750-747X',
'0753-3969',
'0753-4973',
'0758-4113',
'0760-0216',
'0764-4450',
'0764-4469',
'0771-0488',
'0774-2819',
'0774-5915',
'0776-7943',
'0777-6276',
'0790-1763',
'0790-8113',
'0800-0395',
'0811-3653',
'0812-7387',
'0814-1827',
'0818-6839',
'0818-9641',
'0824-0469',
'0858-1088',
'0862-660X',
'0863-0844',
'0867-1710',
'0869-6918',
'0873-4704',
'0883-1351',
'0884-8203',
'0885-4629',
'0885-4645',
'0885-5943',
'0887-3593',
'0891-2963',
'0892-1016',
'0893-1348',
'0895-0237',
'0895-9811',
'0898-1051',
'0898-6207',
'0899-7659',
'0908-8857',
'0911-9450',
'0913-6800',
'0914-5575',
'0915-5805',
'0916-0752',
'0918-1067',
'0918-7960',
'0918-9440',
'0919-6765',
'0920-2250',
'0923-9308',
'0924-7963',
'0930-1526',
'0931-2021',
'0932-0113',
'0932-4739',
'0932-4771',
'0936-9902',
'0939-7140',
'0940-3256',
'0945-3954',
'0945-9871',
'0947-5745',
'0950-7655',
'0952-8369',
'0953-7562',
'0954-1020',
'0958-3157',
'0960-3115',
'0960-3166',
'0960-9822',
'0962-1083',
'0962-8436',
'0962-8452',
'0963-6420',
'0967-0262',
'0967-0637',
'0967-0645',
'0968-0454',
'0968-0470',
'0970-0714',
'0970-9037',
'0971-2208',
'0971-5916',
'0971-6378',
'0971-7196',
'0973-9955',
'0974-7893',
'0993-4332',
'1000-0615',
'1000-0739',
'1000-1050',
'1000-1786',
'1000-2421',
'1000-3118',
'1000-3207',
'1000-3215',
'1000-7083',
'1000-7423',
'1000-7482',
'1001-4276',
'1001-6538',
'1001-7488',
'1002-0071',
'1002-0705',
'1002-0926',
'1005-0507',
'1005-1694',
'1005-295X',
'1005-9628',
'1006-9313',
'1010-061X',
'1010-5220',
'1011-7881',
'1012-2494',
'1013-4425',
'1013-7041',
'1015-8235',
'1017-1827',
'1018-192X',
'1018-3337',
'1018-4171',
'1019-2808',
'1019-5858',
'1019-8415',
'1021-3589',
'1021-5506',
'1022-0828',
'1023-2796',
'1023-3121',
'1025-4870',
'1025-6164',
'1026-051X',
'1026-2296',
'1026-3632',
'1026-5023',
'1026-8774',
'1030-1887',
'1038-4871',
'1040-6182',
'1042-0940',
'1043-8203',
'1049-233X',
'1049-9644',
'1051-3825',
'1051-8932',
'1055-7903',
'1059-1559',
'1059-8707',
'1062-3590',
'1063-5157',
'1064-1262',
'1064-7554',
'1066-5234',
'1067-8611',
'1070-9428',
'1071-8443',
'1077-8306',
'1080-6040',
'1082-6467',
'1090-6924',
'1092-6194',
'1094-0782',
'1094-8074',
'1098-7096',*/
'1103-5897',
'1110-8703',
'1121-1423',
'1121-7545',
'1126-0882',
'1127-6177',
'1130-4251',
'1130-6203',
'1132-0869',
'1133-8466',
'1134-6094',
'1134-7783',
'1148-8425',
'1148-8565',
'1164-5563',
'1164-5571',
'1173-4337',
'1174-9202',
'1175-5326',
'1189-9905',
'1210-4108',
'1210-5759',
'1211-376X',
'1214-1119',
'1217-8837',
'1223-2254',
'1225-0171',
'1226-5071',
'1226-8615',
'1230-2821',
'1243-4442',
'1251-8050',
'1252-607X',
'1257-5496',
'1265-3357',
'1280-9551',
'1280-9659',
'1286-4994',
'1287-0234',
'1300-0179',
'1302-0250',
'1306-3022',
'1313-2989',
'1316-2284',
'1318-1998',
'1320-6133',
'1322-0829',
'1323-1650',
'1323-5818',
'1326-6756',
'1330-0520',
'1335-0552',
'1340-2692',
'1340-9050',
'1341-1160',
'1341-8998',
'1342-1670',
'1342-8144',
'1342-937X',
'1342-9574',
'1343-3954',
'1343-4152',
'1343-8786',
'1345-0662',
'1345-5834',
'1346-4272',
'1348-2653',
'1348-8945',
'1362-1971',
'1367-9120',
'1368-8774',
'1371-7057',
'1374-8297',
'1380-8427',
'1383-4517',
'1383-5769',
'1388-5545',
'1388-7890',
'1392-1657',
'1399-560X',
'1408-3671',
'1413-4703',
'1420-2298',
'1421-3311',
'1434-2944',
'1434-4610',
'1435-1935',
'1435-1943',
'1435-1951',
'1435-6406',
'1437-3254',
'1438-387X',
'1439-6092',
'1439-8621',
'1445-5226',
'1448-5532',
'1464-343X',
'1464-7931',
'1466-5026',
'1467-8039',
'1471-2148',
'1477-2000',
'1477-2019',
'1506-7629',
'1508-1109',
'1513-9700',
'1514-5158',
'1519-1397',
'1519-566X',
'1519-6984',
'1520-541X',
'1524-4156',
'1525-2647',
'1527-0904',
'1528-7092',
'1536-2442',
'1540-7063',
'1555-7332',
'1559-4491',
'1560-8530',
'1562-0891',
'1562-7020',
'1566-0621',
'1567-1348',
'1568-9883',
'1570-7024',
'1570-7555',
'1573-5869',
'1579-0681',
'1590-8399',
'1608-4195',
'1608-5914',
'1608-8700',
'1609-2465',
'1612-4758',
'1613-2327',
'1616-5047',
'1617-416X',
'1631-0683',
'1631-0691',
'1660-9972',
'1661-8726',
'1664-2376',
'1672-3600',
'1672-4291',
'1672-9609',
'1674-5507',
'1676-0603',
'1676-6180',
'1679-6225',
'1679-9283',
'1680-1024',
'1680-7650',
'1681-5556',
'1682-3559',
'1684-0925',
'1684-4130',
'1684-4866',
'1690-7930',
'1726-2038',
'1736-4728',
'1736-602X',
'1738-5261',
'1738_2297',
'1741-7007',
'1742-7584',
'1742-9994',
'1744-9561',
'1745-1000',
'1755-098X',
'1755-6910',
'1756-0500',
'1756-3305',
'1768-1448',
'1781-1104',
'1791-6763',
/*'1808-9798',
'1812-5670',
'1814-3326',
'1817-3381',
'1818-5487',
'1826-0373',
'1833-2331',
'1851-8249',
'1855-5810',
'1860-1324',
'1863-7221',
'1864-5755',
'1864-6417',
'1867-1594',
'1867-1616',
'1868-0356',
'1869-0963',
'1870-3453',
'1871-174X',
'1874-2629',
'1874-4214',
'1874-7787',
'1874-9828',
'1875-2535',
'1880-4330',
'1880-8247',
'1881-9052',
'1881-9079',
'1881-9109',
'1882-6946',
'1883-4493',
'1887-7419',
'1895-3123',
'1895-3131',
'1920-3047',
'1923-4287',
'1932-6203',
'1935-3952',
'1945-9432',
'1945-9440',
'1945-9467',
'1947-5136',
'1959-1982',
'1961-9049',
'1971-1557',
'1976-8354',
'1984-4670',
'2033-494X',
'2038-324X',
'2095-0357',
'2118-9773',
'2156-0382',
'2156-4574',
'2161-7570',
'2180-4249',
'2190-7307',
'2193-7192',
'2194-900X',
'2233-7687',
'2234-6953',
'8756-971X'*/
);

//$issns=array('8756-971X');

//$issns=array('1863-9135');
//$issns=array('1134-6094');

$issns=array('0103-2526','0037-8437','0379-0207');

$issns=array('0324-0770','0767-2071','1760-2610','0072-1018','0016-755X','1210-6100','1019-2808',
'0723-9912','1375-7474','0717-3326','1803-1544');

$issns=array('1859-1434', '0023-5377');

$issns=array('1941-7659','1048-8138');

$issns=array('1866-7384','0013-8886','0005-805X','0013-8916','2072-7151','1342-4092');
$issns=array('1565-1916');
$issns=array('0936-2959');
$issns=array('0076-3519','1616-5047','0737-4038','0006-3606','0014-3820','0022-0949','1616-5047');
$issns=array('0393-9375');
$issns=array('0037-9603','0256-1786');

$issns=array('0091-3669','8756-971X','1943-6270');

$issns=array('0885-3479');

$issns=array('0916-1112','0373-4544','0548-5975');

$issns=array('0378-5742');

$issns=array('0014-1860', '1991-346X', '0002-3477','1605-7678','0568-5117','0373-1278','1024-7688');

$issns=array('0340-3718','0066-4634','2328-9201');

$issns=array('0165-2656','1365-3156','1360-2276','0951-4376','0022-5304','0003-4983','2047-7732','2047-7724','1364-8594',
'0370-0208','0370-0232','0370-0259');

$issns=array('0012-8317');

$issns=array('0429-2871','0389-2751');

$issns=array('0370-9310');

$issns=array('1680-0826','0033-1821','1110-5356','0095-9049','1439-0418','0042-4595','0042-4595','0008-8757','0375-8990','0235-7224','0970-0420','1040-841X','1549-7828','0108-0288','0304-5722','0090-3558',
'0340-7330','0340-7330','0340-7322','0340-7322','1436-5693','1439-0280','1612-4766','0366-578X','0003-276X','1097-0185','0001-706X','1439-0418','0044-2240','2021-3883');

$issns=array('0250-2992','0250-6386');

$issns=array('0721-1635','2090-3790','0001-5709','1000-0674','1006-3021','1755-6724','1000-9515','0253-505X','0336-4917','0767-7367','0370-6869','2220-4563',
'0936-2967','1866-5896','0214-7831','0762-6428','0976-4755','0973-7049','0394-7149','0750-6848',
'0210-6183',
'1624-1940',
'1625-2764',
'1570-0399',
'1911-2173',
'0931-797X',
'2030-6318',
'1803-1366',
'1682-5519',
'1565-8015',
'0300-9491',
'1025-6059',
'0778-4767',
'2090-5238',
'0253-4126',
'1210-8049',
'2234-7909',
'1937-7835',
'2167-5880',
'2167-5872',
'1346-0943',
'1764-6308',
'1573-9953',
'0148-3838',
'1587-1908',
'0099-5444',
'1995-1043',
'0722-3773',
'1584-9074',
'1842-6441',
'0029-196X',
'1967-0133',
'1123-6787',
'1026-8774',
'1288-5509',
'1661-5468',
'0392-9450',
'1978-9807',
'0495-8314',
'1303-2712',
'0252-1911',
'1656-4650',
'0042-8752',
'1615-3472'
);

$issns=array('0178-7217','0249-0102','0134-3475','1889-3074','1578-1666','1868-0356','0464-4263','1580-2612','0583-6050',
'0002-5208','1525-9153','0716-6478','1214-0066','1297-9678','0044-8435','1989-6581',
'1985-1944','1267-2157','0320-9652','1666-115X','0366-0176','0505-205X','0375-7633',
'0302-671X','0374-6291','0153-9361','0395-7306','2277-1808','0065-5554');

$issns=array('0453-1906','0093-6812','2114-978X','1938-4408','1934-0451','1157-4402','1028-3420','2192-4201','2039-0394','2039-0408','0388-418X',
'1224-6808','1374-8505','0394-1914','1825-5272','1054-3139','1095-9289','1139-5192','0552-9360','2267-8840',
'0810-8889','0082-4755','1046-8390','1365-3059','1308-4119','1984-2961','0103-846X','1349-1237',
'0869-5938','0081-6426','1803-1544','1978-9807');

$issns=array('0342-412X');

$issns=array('0735-3987');


// IPNI
$issns=array('1280-8571','1639-4798');
$issns=array('1095-8339','0024-4074');
$issns=array('0006-8071','2032-3913');
$issns=array('1374-7886');
$issns=array('1537-5315','1058-5893','0040-9618');
$issns=array('1817-406X','1999-3110');
$issns=array('0075-5974','1874-933X');
$issns=array('0303-9153');
$issns=array('0374-6313');
$issns=array('0968-0446','1475-2956');
$issns=array('1055-3177','1945-6174');
$issns=array('1477-2000');
$issns=array('0254-6299');

// Other
$issns=array('0374-5708');

$issns=array('0075-3920');

$issns=array('0075-207X');

$issns=array('1133-6889','0210-6183','0210-6191','0210-6213');

$issns=array('2178-2547');

$issns=array('0870-3876', '1131-933X');

$issns=array('1137-6120','1220-3823');

$issns=array('2325-4467','2337-0173');

$issns=array('1341-6707','0037-9611');

$issns_processed = array();

$count = 0;

while (count($issns) > 0)
{
	echo "ISSNs to process\n";
	print_r($issns);

	echo "ISSNs done\n";
	print_r($issns_processed);
	
	/*
	echo "ISSNs to process (array_diff)\n";
	$issns = array_diff($issns, $issns_processed);
	print_r($issns);
	*/
	
	$issn = array_shift($issns);
	$issns_processed[] = $issn;
	
	$url = 'http://xissn.worldcat.org/webservices/xid/issn/' . $issn . '?method=getHistory&format=json';
	
	$json = get($url);
	if ($json != '')
	{
		echo $json;
		
		$filename = dirname(__FILE__) . '/issn/' . str_replace('-','', $issn) . '.json';
		file_put_contents($filename, $json);
		
		$obj = json_decode($json);
		
		//print_r($obj);
		
		$preceding = array();
		$succeeding = array();
		
		// Get relations between journals		
		if (isset($obj->group))
		{
			foreach ($obj->group as $g)
			{
				foreach ($g->list as $list)
				{
					switch ($g->rel)
					{							
						case 'preceding':
							$preceding[] = $list->issn;
							break;
							
						case 'succeeding':
							$succeeding[] = $list->issn;
							break;
							
						case 'this':
						default:
							break;
					}
				}
			}
		}
		
		// clean
		$preceding = array_unique($preceding);
		$succeeding = array_unique($succeeding);
		
		// Now handle this journal
		if (isset($obj->group))
		{
			foreach ($obj->group as $g)
			{
				foreach ($g->list as $list)
				{
					if ($g->rel == 'this')
					{
						$journal = $list;
						$journal->_id = 'issn/' . $list->issn;
						
						$journal->type = 'journal';
						
						if (count($preceding) > 0)
						{
							$journal->preceding = $preceding;
						}
						if (count($succeeding) > 0)
						{
							$journal->succeeding = $succeeding;
						}
						
						// Add to queque
						foreach ($preceding as $i)
						{
							if (!in_array($i, $issns_processed) && !in_array($i, $issns))
							{
								$issns[] = $i;
							}
						}
						foreach ($succeeding as $i)
						{
							if (!in_array($i, $issns_processed) && !in_array($i, $issns))
							{
								$issns[] = $i;
							}
						}					
						
						// thumbnail of journal 
						get_issn_thumbnail($journal);				
						
						$journal->provenance = array();
						$worldcat = new stdclass;
						$worldcat->time = date(DATE_ISO8601, time());
						$worldcat->url = $url;
						$journal->provenance[] = $worldcat;
	
						print_r($journal);
						
						if (1)
						{
							echo "CouchDB...\n";
							$couch->add_update_or_delete_document($journal,  $journal->_id);
						}
						
					}
				}
			}
		}
		
	}
	
	if (($count++ % 10) == 0)
	{
		$rand = rand(2000000, 6000000);
    	echo '...sleeping for ' . round(($rand / 1000000),2) . ' seconds' . "\n";
    	usleep($rand);
    }
	
}


?>